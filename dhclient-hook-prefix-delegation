# This script assigns a delegated IPv6 prefix obtained via DHCPv6 to tun0
#
# This script is designed to be called from dhclient-script (isc-dhcp-client).
# Just copy it to /etc/dhcp/dhclient-exit-hooks.d/prefix_delegation to enable
# it.

add_prefix()
{
    # We expect the radvd.conf has been generated by the init script. So it
    # follows a strict syntax

    [ -e /etc/radvd.conf ] || return
    sed -i -re "s|prefix [0-9a-fA-F:/]* {/prefix $1 {/" /etc/radvd.conf
    sed -i -re "s|route [0-9a-fA-F:/]* {/route $1 {/" /etc/radvd.conf
    kill $(cat /run/radvd.pid)
    radvd --logmethod stderr
}

change_prefix()
{
    # Just add the new prefix and leave SLACC make its job (tun0 is configured
    # with accept_ra=2)
    add_prefix $2
}

del_prefix()
{
    # Right, we uplink router has probably died. If you have a backup border
    # router, you may want this border router stop to advertise. So the Wi-SUN
    # device will migrate to the backup border router.
    #
    # If it is not the case, let's continue to advertise the last known prefix.
    # So, with a bit of chance, we will get the same prefix when the uplink
    # router will get back.
    #
    # So, finally, just do nothing
}

case $reason in
    BOUND6|EXPIRE6|REBIND6|REBOOT6|RENEW6)
        [ -e "/sys/class/net/tun0" ] || die "tun0 does not exist"
        if [ -n "$old_ip6_prefix" -a -n "$new_ip6_prefix" ]; then
            if ["$old_ip6_prefix" != "$new_ip6_prefix"]; then
                change_prefix "$old_ip6_prefix" "$new_ip6_prefix"
            fi
        elif [ -n "$old_ip6_prefix" ]
            del_prefix "$old_ip6_prefix"
        elif [ -n "$new_ip6_prefix" ]
            add_prefix "$new_ip6_prefix"
        else
            # Nothing to do
        fi
    ;;
esac
